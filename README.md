# Game Demo - Skynet æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶

åŸºäº [Skynet](https://github.com/cloudwu/skynet) å¼€å‘çš„æ¸¸æˆæœåŠ¡å™¨æ¡†æ¶ï¼Œé‡‡ç”¨ Actor æ¨¡å‹å’Œ ECS æ¶æ„è®¾è®¡ï¼Œæ”¯æŒé«˜å¹¶å‘ã€åˆ†å¸ƒå¼éƒ¨ç½²ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ ¸å¿ƒæœåŠ¡](#æ ¸å¿ƒæœåŠ¡)
- [åè®®ç³»ç»Ÿ](#åè®®ç³»ç»Ÿ)
- [æ•°æ®åº“](#æ•°æ®åº“)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸ¯ é¡¹ç›®ç®€ä»‹

Game Demo æ˜¯ä¸€ä¸ªåŸºäº Skynet æ¡†æ¶çš„æ¸¸æˆæœåŠ¡å™¨é¡¹ç›®ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **é«˜æ€§èƒ½**: åŸºäº Skynet Actor æ¨¡å‹ï¼Œæ”¯æŒé«˜å¹¶å‘è¿æ¥
- **æ¨¡å—åŒ–**: é‡‡ç”¨ ECS æ¶æ„ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- **åè®®é©±åŠ¨**: ä½¿ç”¨ Protobuf è¿›è¡Œåè®®å®šä¹‰å’Œåºåˆ—åŒ–
- **æ•°æ®æŒä¹…åŒ–**: æ”¯æŒ MongoDB æ•°æ®åº“å­˜å‚¨
- **åˆ†å¸ƒå¼**: æ”¯æŒå¤šæœåŠ¡ã€å¤šèŠ‚ç‚¹éƒ¨ç½²
- **å¯æ‰©å±•**: ç½‘å…³ã€Agentã€ç™»å½•æœåŠ¡ç­‰æ ¸å¿ƒç»„ä»¶å¯ç‹¬ç«‹æ‰©å±•

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚    Gate     â”‚ â† ç½‘å…³æœåŠ¡ï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚    Agent    â”‚ â† æ¸¸æˆé€»è¾‘æœåŠ¡ï¼Œå¤„ç†ç©å®¶ä¸šåŠ¡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB    â”‚ â† æ•°æ®æŒä¹…åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Logind    â”‚ â† ç™»å½•æœåŠ¡ï¼ˆMaster/Slave æ¨¡å¼ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæœåŠ¡

1. **Gate (ç½‘å…³æœåŠ¡)**
   - å¤„ç†å®¢æˆ·ç«¯ TCP è¿æ¥
   - æ¶ˆæ¯è·¯ç”±å’Œè½¬å‘
   - è¿æ¥ç®¡ç†å’Œè´Ÿè½½å‡è¡¡

2. **Agent (æ¸¸æˆé€»è¾‘æœåŠ¡)**
   - ç©å®¶æ¸¸æˆé€»è¾‘å¤„ç†
   - ç”¨æˆ·çŠ¶æ€ç®¡ç†
   - æ¶ˆæ¯åˆ†å‘å’Œå¤„ç†

3. **Logind (ç™»å½•æœåŠ¡)**
   - Master/Slave æ¶æ„
   - è´¦å·éªŒè¯å’Œç”¨æˆ·åˆ›å»º
   - ç™»å½•æµç¨‹ç®¡ç†

4. **MongoDB (æ•°æ®æœåŠ¡)**
   - æ•°æ®æŒä¹…åŒ–
   - è´¦å·ä¿¡æ¯å­˜å‚¨
   - æ¸¸æˆæ•°æ®ç®¡ç†

## ğŸ“ ç›®å½•ç»“æ„

```
game_demo/
â”œâ”€â”€ skynet/              # Skynet æ¡†æ¶æ ¸å¿ƒä»£ç 
â”œâ”€â”€ config/              # æœåŠ¡å™¨é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ main_node       # ä¸»èŠ‚ç‚¹é…ç½®
â”‚   â””â”€â”€ test_node       # æµ‹è¯•èŠ‚ç‚¹é…ç½®
â”œâ”€â”€ common/              # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ master_func.lua # Master æœåŠ¡å‡½æ•°
â”‚   â”œâ”€â”€ slave_func.lua  # Slave æœåŠ¡å‡½æ•°
â”‚   â””â”€â”€ preload.lua     # é¢„åŠ è½½è„šæœ¬
â”œâ”€â”€ logic/               # æ¸¸æˆé€»è¾‘
â”‚   â”œâ”€â”€ base/           # åŸºç¡€åº“
â”‚   â”œâ”€â”€ service/        # æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ agent/      # Agent æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ gated/      # Gate æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ logind/     # ç™»å½•æœåŠ¡
â”‚   â”‚   â””â”€â”€ main_mongodb/ # MongoDB æœåŠ¡
â”‚   â”œâ”€â”€ module/         # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ account/    # è´¦å·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ login/      # ç™»å½•æ¨¡å—
â”‚   â”‚   â””â”€â”€ user/      # ç”¨æˆ·æ¨¡å—
â”‚   â””â”€â”€ define/         # å¸¸é‡å®šä¹‰
â”œâ”€â”€ proto/               # åè®®æ–‡ä»¶
â”‚   â””â”€â”€ pb/             # ç¼–è¯‘åçš„ .pb æ–‡ä»¶
â”œâ”€â”€ tools/               # å·¥å…·è„šæœ¬
â”‚   â””â”€â”€ ptotools/       # åè®®ç”Ÿæˆå·¥å…·
â”œâ”€â”€ shell/               # Shell è„šæœ¬
â”‚   â”œâ”€â”€ start.sh        # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ stop.sh         # åœæ­¢è„šæœ¬
â”‚   â””â”€â”€ gen_proto.sh    # åè®®ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ start_up/            # å¯åŠ¨å…¥å£
â”‚   â””â”€â”€ main_start.lua  # ä¸»å¯åŠ¨è„šæœ¬
â””â”€â”€ test/                # æµ‹è¯•è„šæœ¬
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Linux/macOS (Windows éœ€è¦ WSL æˆ– Git Bash)
- Lua 5.3+
- Python 3.x (ç”¨äºåè®®ç”Ÿæˆ)
- MongoDB (ç”¨äºæ•°æ®å­˜å‚¨)
- GCC/Clang (ç¼–è¯‘ Skynet)

### ç¼–è¯‘ Skynet

```bash
cd skynet
make linux  # Linux ç³»ç»Ÿ
# æˆ– make macosx  # macOS ç³»ç»Ÿ
```

### é…ç½®æ•°æ®åº“

ç¼–è¾‘ `config/main_node`ï¼Œä¿®æ”¹ MongoDB è¿æ¥ä¿¡æ¯ï¼š

```lua
mongodb_host = "127.0.0.1"
mongodb_port = "27017"
mongodb_user = "root"
mongodb_password = "123"
```

### ç”Ÿæˆåè®®

```bash
bash shell/gen_proto.sh
```

### å¯åŠ¨æœåŠ¡å™¨

```bash
bash shell/start.sh
```

### æµ‹è¯•ç™»å½•

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•è„šæœ¬
skynet/skynet config/test_node
```

## âš™ï¸ é…ç½®è¯´æ˜

### ä¸»é…ç½®æ–‡ä»¶ (config/main_node)

```lua
-- åŸºç¡€é…ç½®
host_id = "120"           -- æœåŠ¡å™¨ ID
thread = 8                 -- å·¥ä½œçº¿ç¨‹æ•°
gate_port = 8888           -- ç½‘å…³ç«¯å£
login_port = 33021         -- ç™»å½•ç«¯å£

-- ç™»å½•æœåŠ¡é…ç½®
slave_cnt = 3              -- Slave æœåŠ¡æ•°é‡
maxonline = 2000           -- æœ€å¤§åœ¨çº¿äººæ•°

-- Agent é…ç½®
agent_init_cnt = 2         -- åˆå§‹ Agent æ•°é‡
agent_max_user_cnt = 500   -- å•ä¸ª Agent æœ€å¤§ç”¨æˆ·æ•°

-- æ•°æ®åº“é…ç½®
mongodb_host = "127.0.0.1"
mongodb_port = "27017"
```

## ğŸ”§ æ ¸å¿ƒæœåŠ¡

### Gate æœåŠ¡

ç½‘å…³æœåŠ¡ï¼Œè´Ÿè´£å®¢æˆ·ç«¯è¿æ¥ç®¡ç†å’Œæ¶ˆæ¯è·¯ç”±ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- æ¥å—å®¢æˆ·ç«¯ TCP è¿æ¥
- æ¶ˆæ¯åŒ…è§£æå’Œè½¬å‘
- è¿æ¥çŠ¶æ€ç®¡ç†
- Agent è´Ÿè½½å‡è¡¡

**å…³é”®ä»£ç ï¼š** `logic/service/gated/gated.lua`

### Agent æœåŠ¡

æ¸¸æˆé€»è¾‘æœåŠ¡ï¼Œå¤„ç†ç©å®¶ä¸šåŠ¡é€»è¾‘ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- ç©å®¶ç™»å½•å’Œç™»å‡º
- æ¸¸æˆæ¶ˆæ¯å¤„ç†
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- æ•°æ®ç¼“å­˜

**å…³é”®ä»£ç ï¼š** `logic/service/agent/agent.lua`

### Logind æœåŠ¡

ç™»å½•æœåŠ¡ï¼Œé‡‡ç”¨ Master/Slave æ¶æ„ã€‚

**Master æœåŠ¡ï¼š**
- ç›‘å¬ç™»å½•ç«¯å£
- åˆ†é…è¿æ¥ç»™ Slave
- åè°ƒç™»å½•æµç¨‹

**Slave æœåŠ¡ï¼š**
- å¤„ç†å…·ä½“ç™»å½•è¯·æ±‚
- è´¦å·éªŒè¯
- ç”¨æˆ·åˆ›å»º

**å…³é”®ä»£ç ï¼š**
- Master: `common/master_func.lua`
- Slave: `common/slave_func.lua`

## ğŸ“¡ åè®®ç³»ç»Ÿ

### åè®®å®šä¹‰

åè®®ä½¿ç”¨ Protobuf å®šä¹‰ï¼Œå­˜æ”¾åœ¨ `tools/ptotools/proto/proto_desc/` ç›®å½•ã€‚

ç¤ºä¾‹ (`login.proto`):
```protobuf
syntax = "proto3";

package Login;

message c2splaylogin {
    string accountType = 1;
    string appId = 2;
    string cchid = 3;
    string account = 4;
    string passwd = 5;
}
```

### åè®®ç”Ÿæˆ

è¿è¡Œåè®®ç”Ÿæˆè„šæœ¬ï¼š

```bash
bash shell/gen_proto.sh
```

ç”Ÿæˆçš„æ–‡ä»¶ï¼š
- `proto/pb/*.pb` - Protobuf äºŒè¿›åˆ¶æ–‡ä»¶
- `logic/base/netPb.lua` - Lua åè®®æ˜ å°„è¡¨

### åè®®ä½¿ç”¨

**æœåŠ¡ç«¯ç¼–ç ï¼š**
```lua
local protobuf = require "protobuf"
local data = {
    accountType = "1",
    account = "test",
    passwd = "123456"
}
local msg = protobuf.encode("Login.c2splaylogin", data)
```

**æœåŠ¡ç«¯è§£ç ï¼š**
```lua
local loginInfo = protobuf.decode("Login.c2splaylogin", packet)
```

## ğŸ’¾ æ•°æ®åº“

### MongoDB æ“ä½œ

æ¡†æ¶å°è£…äº† MongoDB æ“ä½œæ¥å£ï¼š

**æ’å…¥æ•°æ®ï¼š**
```lua
skynet.call(".mongodb", "lua", "insert", {
    database = "game",
    collection = "users",
    doc = {_id = "user123", name = "test"}
})
```

**æŸ¥è¯¢æ•°æ®ï¼š**
```lua
local result = skynet.call(".mongodb", "lua", "findOne", {
    database = "game",
    collection = "login",
    query = {_id = account}
})
```

**æ›´æ–°æ•°æ®ï¼š**
```lua
skynet.call(".mongodb", "lua", "update", {
    database = "game",
    collection = "login",
    selector = {_id = account},
    update = {
        ["$setOnInsert"] = {_id = account, userTbl = {}},
        ["$set"] = {["userTbl." .. userId] = true}
    },
    upsert = true,
    multi = false
})
```

## ğŸ“– å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åè®®

1. åœ¨ `tools/ptotools/proto/proto_desc/` åˆ›å»º `.proto` æ–‡ä»¶
2. è¿è¡Œ `bash shell/gen_proto.sh` ç”Ÿæˆåè®®
3. åœ¨æœåŠ¡ä¸­æ³¨å†Œåè®®å¤„ç†å‡½æ•°

### æ·»åŠ æ–°æœåŠ¡

1. åœ¨ `logic/service/` åˆ›å»ºæœåŠ¡ç›®å½•
2. å®ç°æœåŠ¡ä¸»æ–‡ä»¶ï¼ˆå¦‚ `service.lua`ï¼‰
3. åœ¨ `start_up/main_start.lua` ä¸­å¯åŠ¨æœåŠ¡

### æ·»åŠ æ–°æ¨¡å—

1. åœ¨ `logic/module/` åˆ›å»ºæ¨¡å—ç›®å½•
2. å®ç°æ¨¡å—é€»è¾‘
3. åœ¨éœ€è¦çš„åœ°æ–¹ `Import` æ¨¡å—

### Socket æ“ä½œæ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦**: Skynet çš„ `socket.read` è¿”å›çš„æ˜¯å†…éƒ¨ bufferï¼Œå¿…é¡»ç«‹å³ä½¿ç”¨ `skynet.tostring` å¤åˆ¶ï¼š

```lua
-- âœ… æ­£ç¡®
local block = socket.read(fd, 2)
local data = skynet.tostring(block, 2)

-- âŒ é”™è¯¯ - ä¼šå¯¼è‡´æ®µé”™è¯¯
local block = socket.read(fd, 2)
-- ... å…¶ä»–æ“ä½œ ...
local data = skynet.tostring(block, 2)  -- block å¯èƒ½å·²è¢«å¤ç”¨
```

### æœåŠ¡é—´é€šä¿¡

**åŒæ­¥è°ƒç”¨ (skynet.call):**
```lua
local result = skynet.call(service, "lua", "command", arg1, arg2)
```

**å¼‚æ­¥è°ƒç”¨ (skynet.send):**
```lua
skynet.send(service, "lua", "command", arg1, arg2)
```

**å¤„ç†è¯·æ±‚ï¼š**
```lua
skynet.dispatch("lua", function(session, source, cmd, ...)
    local f = CMD[cmd]
    if session ~= 0 then
        skynet.ret(skynet.pack(f(...)))  -- éœ€è¦å›å¤
    else
        f(...)  -- ä¸éœ€è¦å›å¤
    end
end)
```

## â“ å¸¸è§é—®é¢˜

### 1. æ®µé”™è¯¯ (Segmentation Fault)

**åŸå› **: ç›´æ¥ä½¿ç”¨ `socket.read` è¿”å›çš„ bufferï¼Œæ²¡æœ‰ç«‹å³å¤åˆ¶ã€‚

**è§£å†³**: ä½¿ç”¨ `skynet.tostring(block, size)` ç«‹å³å¤åˆ¶æ•°æ®ã€‚

### 2. åè®®è§£æå¤±è´¥

**åŸå› **: 
- åè®®æœªæ³¨å†Œ
- åè®®åç§°ä¸åŒ¹é…ï¼ˆæ³¨æ„ package å‰ç¼€ï¼‰

**è§£å†³**: 
- æ£€æŸ¥ `protobufinit.lua` æ˜¯å¦æ³¨å†Œäº†åè®®æ–‡ä»¶
- ç¡®è®¤ä½¿ç”¨å®Œæ•´çš„åè®®åç§°ï¼ˆå¦‚ `Login.c2splaylogin`ï¼‰

### 3. MongoDB è¿æ¥å¤±è´¥

**åŸå› **: é…ç½®é”™è¯¯æˆ– MongoDB æœªå¯åŠ¨ã€‚

**è§£å†³**: 
- æ£€æŸ¥ `config/main_node` ä¸­çš„ MongoDB é…ç½®
- ç¡®è®¤ MongoDB æœåŠ¡å·²å¯åŠ¨
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

### 4. æœåŠ¡å¯åŠ¨å¤±è´¥

**åŸå› **: 
- é…ç½®æ–‡ä»¶è·¯å¾„é”™è¯¯
- ç«¯å£è¢«å ç”¨
- ä¾èµ–æœåŠ¡æœªå¯åŠ¨

**è§£å†³**: 
- æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„
- ä½¿ç”¨ `netstat` æ£€æŸ¥ç«¯å£å ç”¨
- æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å®šä½é—®é¢˜

## ğŸ“ å¼€å‘è§„èŒƒ

1. **å‘½åè§„èŒƒ**
   - æœåŠ¡æ–‡ä»¶ä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿ï¼š`agent.lua`
   - æ¨¡å—ä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿ï¼š`user_manager.lua`
   - å¸¸é‡ä½¿ç”¨å¤§å†™+ä¸‹åˆ’çº¿ï¼š`MAX_USER_COUNT`

2. **ä»£ç ç»„ç»‡**
   - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹ç›®å½•
   - å…¬å…±åŠŸèƒ½æ”¾åœ¨ `common/` æˆ– `logic/base/`
   - ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ `logic/module/`

3. **é”™è¯¯å¤„ç†**
   - ä½¿ç”¨ `pcall` åŒ…è£…å¯èƒ½å‡ºé”™çš„æ“ä½œ
   - è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - ä¼˜é›…å¤„ç†å¼‚å¸¸æƒ…å†µ

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº Skynet æ¡†æ¶å¼€å‘ï¼Œéµå¾ª Skynet çš„ MIT è®¸å¯è¯ã€‚

## ğŸ‘¥ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**Happy Coding! ğŸ®**
