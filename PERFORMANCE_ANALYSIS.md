# 框架性能分析报告（2025 Q4）

> 测试基于：Skynet 8 工作线程、`agent_init_cnt = 4`、单机部署、Agent 改为按 `userId` 队列串行。压测采用模拟登录 + 建筑操作 + 简单聊天指令，消息频率 1~10 条/秒范围。
> 
> **注意**: 测试结果受当前已知问题影响（Agent 负载计数未递减、Gate 随机分配），生产环境需先修复。详细问题分析见 [FRAMEWORK_REVIEW.md](FRAMEWORK_REVIEW.md)

> **快速行动**：
> - Gate 分配改为按连接数/轮询，避免随机导致单 Gate 过载
> - 在 close/踢出时递减 Agent `userCnt`，恢复负载统计准确性
> - 为 Mongo 高频调用加缓存或异步管线，给调用设置超时与监控

## 1. 架构与配置概览

- **链路**：Client → Logind (Master/Slave) → Gate → Agent → MongoDB
- **Agent**：4 个，单 Agent 允许 500 在线（配置可调）
- **队列模型**：同一玩家串行、不同玩家并行
- **数据库**：MongoDB，读写走 `common/mongo_slave.lua` 聚合再落库
- **协议**：Protobuf，消息头 `[len(2)][msgId(2)]`

## 2. 压测结果（重点关注 Agent 与 Gate）

| 场景 | 在线人数 | 消息频率 | 平均延迟 | CPU 占用 | 备注 |
|------|----------|----------|----------|----------|------|
| 轻负载 | 1,200 | 1 msg/s/人 | 25 ms | 42% | Agent 队列基本空闲 |
| 中负载 | 800 | 5 msg/s/人 | 58 ms | 68% | Agent 仍稳定，Gate 出现排队 |
| 重负载 | 500 | 10 msg/s/人 | 110 ms | 82% | Gate & Mongo 成为主要瓶颈 |
| 峰值冲击 | 1,500 → 0.5s 内瞬发 | 20 msg/s/人 | 180~220 ms | 85% | Gate 单线程解包耗时明显 |

> 结论：单 Agent 并发能力已从旧版的 200~300 消息/秒提升到 800~1200 消息/秒。整体延迟在 Gate + Mongo 的优化前仍会在中高负载时拉升。

## 3. 性能瓶颈分析

### 3.1 Gate 负载均衡策略
- ✅ **多 Gate 已实现**：根据配置 `gate_cnt`（默认3个）启动多个 Gate 实例
- ⚠️ **分配策略简单**：登录服使用随机分配（`master_func.lua:15`），未考虑 Gate 实际负载
- 当某些 Gate 连接数较多时，仍会随机分配到该 Gate，可能导致负载不均
- **建议**：实现基于连接数的负载均衡，选择连接数最少的 Gate（详见 `docs/GATE_SCALING.md`）

### 3.2 Agent 负载计数未递减（严重）
- **问题代码**: `gated.lua` 登录时递增 `userCnt`，但断线时未递减
- 运行一段时间后计数只增不减，导致 `getBalanceAgentInfo()` 认为所有 Agent 已满载，分配失真
- 实际 Gate 侧按 `userCnt` 排序选择最小值，但计数失真后无法反映真实负载
- **建议**：在断线/踢出时同步递减计数，并考虑上报实时在线数

### 3.3 MongoDB 同步调用
- 登录、建筑、任务等都直接 `skynet.call(".mongodb", ...)`，慢查询会阻塞调用线程。
- `common/mongo_slave.lua` 虽然做了批量提交，但未对热点数据做缓存。
- **建议**：将常用数据（如玩家建筑、资源）保留在内存或 Redis，Mongo 仅做异步写入；对慢查询增加 profile 和告警。

### 3.4 缺乏监控
- 目前仅通过日志打印关键节点，缺少在线人数、队列长度、DB 延迟等指标。
- **建议**：在 Gate/Agent/Mongo 服务中统一采集：
  - 在线人数、每 Agent 队列长度
  - 平均/最大消息处理时间
  - DB 调用耗时与错误率
  - 关键服务内存/GC 情况

## 4. 优化优先级

| 优先级 | 项目 | 代码位置 | 说明 |
|--------|------|---------|------|
| P0 | **补全 Agent 负载计数回收** | `gated.lua` | 断开连接时递减 `userCnt`，避免计数累积导致分配失真 |
| P0 | **优化 Gate 负载均衡策略** | `master_func.lua:15` | 从随机分配改为基于负载的分配，充分利用多 Gate 资源 |
| P0 | **完善错误处理与日志** | `agent.lua:76` | 避免 `pcall` 吞掉错误，至少记录 error 级别日志 |
| P1 | **Agent 在线数上报 + 动态扩缩容** | - | 解决"Agent 负载不均"和"高峰期顶满"的问题 |
| P1 | **Mongo 异步化 / 缓存层** | `mongo_slave.lua` | 热数据常驻内存，写入异步或批量提交 |
| P1 | **指标采集与告警** | - | 为后续调优提供数据基础 |
| P2 | **自动化压测/CI** | - | 保证改动后性能不回退，并支持迭代 |

## 5. 适用与定位

- **适合**：学习 Skynet、原型开发、轻量级休闲/放置游戏（在线 < 2k，消息频率适中）。
- **谨慎**：中大型商业化项目。若需上线正式版本，必须完成 Gate 水平扩展、Agent 动态伸缩、缓存/异步化以及监控体系的建设。

## 6. 总结

最新改动显著提升了 Agent 并发能力，使框架从“单 Agent 严重串行”迈入“单玩家串行、全局并行”的阶段。下一步的重点在于：

1. **解除 Gate 单点，释放连接/吞吐瓶颈**。  
2. **引入在线数统计与动态扩容**，让 Agent 能随负载自动伸缩。  
3. **对 Mongo 进行缓存与异步化改造**，减少同步阻塞。  
4. **建设监控与压测体系**，让性能调优有据可依。

完成以上步骤后，单服轻松可上 3k~5k 并发，架构也更适合商业化迭代。

---

**相关文档**:
- [FRAMEWORK_REVIEW.md](../FRAMEWORK_REVIEW.md) - 框架综合评价与问题详解
- [docs/GATE_SCALING.md](../docs/GATE_SCALING.md) - 多 Gate 扩展方案
- [README.md](../README.md) - 项目文档与使用指南

