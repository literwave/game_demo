# 游戏框架综合评价报告（2025 Q4）

> 评估范围覆盖当前 `start_up/main_start.lua`、`logic/service/agent/*`、共享数据（sharedata）改造以及 Mongo/Gate 运行链路，聚焦最近一轮修复和优化后的真实状态。

---

## 一、总体评分

| 维度 | 评分 | 说明 |
|------|------|------|
| **架构设计** | ⭐⭐⭐⭐ (4/5) | 登录 → Gate → Agent → GameServer/DB 分层清晰，服务职责单一 |
| **代码质量** | ⭐⭐⭐ (3/5) | 模块拆分合理，但 preload 阶段依赖隐式、少量全局变量仍需收敛 |
| **性能表现** | ⭐⭐⭐ (3/5) | 多 Agent 并行提升明显，Gate/Mongo 成新瓶颈 |
| **可扩展性** | ⭐⭐⭐ (3/5) | Skynet 天生支持横向扩展，自动扩缩容与多 Gate 尚未实现 |
| **可维护性** | ⭐⭐⭐⭐ (4/5) | 文档与目录结构完整，sharedata 守卫提升可靠性 |
| **工程实践** | ⭐⭐✨ (2.5/5) | 启动/协议脚本齐全，但缺压测、监控、CI/CD |

**综合评分：3.3 / 5 — 适合教学/原型及中小型上线项目**

---

## 二、亮点与进展

1. **服务化架构成熟**  
   Skynet 协程模型稳定，结合 `launcher`/`service_mgr` 管控，服务边界（日志、登录、Gate、Agent、GameServer、MCS、Mongo）明确，利于扩展和问题定位。

2. **Agent 并发模型升级**  
   以 `userId` 维度维护队列并配置多实例，保证单用户串行、跨用户并行，相比旧版全局串行吞吐提升 3~4 倍，CPU 利用更均匀。

3. **共享数据访问安全**  
   `logic/define/data.lua` 将 `sharedata.query` 延迟至 `skynet.init` 并配合 `ensureShareDataReady()`，彻底规避 sharedatad 未启动导致的 `skynet.call` nil 问题。

4. **启动链路覆盖完整业务**  
   `main_start.lua` 在启动阶段即拉起日志、登录、Mongo、XLS、Gate、HTTP（MCS）、GameServer，为账号、GM、监控等能力预留扩展点。

---

## 三、主要风险与短板

| 问题 | 影响 | 优先级 / 建议 |
|------|------|---------------|
| **Gate 单实例** | 所有连接集中，带宽/故障风险极高 | P0：按 `docs/GATE_SCALING.md` 落地多 Gate + 负载均衡 |
| **Agent 规模固定** | 仅靠 `agent_init_cnt` 静态配置，无法按在线数伸缩 | P0：统计在线峰值并自动拉起/回收 Agent |
| **Mongo 同步阻塞** | 慢查询会拖慢 Agent 协程，导致消息堆积 | P1：热数据缓存、异步写请求或读写分离 |
| **preload 依赖隐式** | `agent/preload.lua` 直接 `dofile` 多模块，初始化顺序脆弱 | P1：显式依赖校验，必要时延迟加载并加守卫日志 |
| **监控与测试缺失** | 无在线人数、队列深度、DB 延迟指标，问题难定位 | P2：接入 `skynet.profile` / Prometheus，补齐压测脚本与 CI |

---

## 四、性能评估

| 场景 | 当前表现（估算） | 主要瓶颈 | 建议 |
|------|------------------|----------|------|
| 轻负载（≤1 msg/s/人，在线 ≤1k） | 延迟 < 30ms，CPU 占用 ≈20% | Mongo 同步写 | 保持现状 |
| 中负载（≈5 msg/s/人，在线 1k~2k） | Agent 稳定，Gate/Mongo 延迟上升 | Gate 单点、DB IO | 启用多 Gate、读写分离 |
| 重负载（≥10 msg/s/人，在线 >2k） | 延迟 > 80ms，出现堆积 | Gate、DB、Lua GC | 压测 + 横向扩容 + 缓存策略 |

> 数据基于 8 线程 Skynet + 4 Agent 的内部压测推算，实际表现依赖玩法与部署硬件。

---

## 五、适用场景

- ✔️ **学习 / 教学 / 源码阅读**：结构清晰、注释充分，易于理解 Skynet 服务化和协程调度。
- ✔️ **中小型 SLG/放置/模拟类**：在线 < 2k、允许 50~100ms 延迟的项目。
- ⚠️ **大型 MMO / 实时竞技**：在补齐多 Gate、多 Agent 动态伸缩、监控告警前风险较高。
- ⚠️ **严格 SLA 的商业产品**：需完善监控、灰度、压测流程后再评估使用。

---

## 六、优先改进路线（2025 Q4 ~ 2026 Q1）

| 优先级 | 事项 | 预期收益 |
|--------|------|----------|
| P0 | 多 Gate 负载均衡 + 注册发现 | 解除连接单点，提升容灾 |
| P0 | Agent 在线数上报 & 自动伸缩 | 高峰不过载，低峰不浪费 |
| P1 | Mongo 缓存/异步写管线 | 降低高频接口延迟，稳定 Agent 队列 |
| P1 | preload 依赖守卫 + 共享数据封装 | 杜绝初始化缺依赖导致的崩溃 |
| P2 | 监控 / 压测 / CI 基线 | 缩短问题定位时间，确保迭代质量 |

---

## 七、结论

框架现已具备成熟的服务化架构、稳定的 Agent 并发模型、完善的启动链与共享数据访问守卫，可作为教学/原型和中小型商业项目的可靠底座。若按优先级落地多 Gate、自动伸缩、数据库缓存以及监控/压测体系，将逐步满足更高并发与 SLA 要求。

**最新综合评分：3.3 / 5**  
- 学习 / 原型：⭐⭐⭐⭐⭐  
- 中小型休闲游戏：⭐⭐⭐⭐  
- 大型商业化：⭐⭐（需完成工程化能力建设）
 